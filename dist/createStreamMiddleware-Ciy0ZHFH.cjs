"use strict";const m=require("./browser-DjQM3S9H.cjs"),M=require("./safeEventEmitter.cjs");function b(n={}){const i={},o=new m.browserExports.Duplex({objectMode:!0,read:()=>{},write:u}),c=new M;return{events:c,middleware:(e,t,r,s)=>{i[e.id]={req:e,res:t,next:r,end:s},d(e)},stream:o};function d(e){o.push(e)}function u(e,t,r){let s=null;try{!e.id?l(e):f(e)}catch(a){s=a}r(s)}function f(e){const t=e.id,r=i[t];if(!r){console.warn(`StreamMiddleware - Unknown response id "${t}"`);return}delete i[t],Object.assign(r.res,e),setTimeout(r.end)}function l(e){n!=null&&n.retryOnMessage&&e.method===n.retryOnMessage&&w(),c.emit("notification",e)}function w(){Object.values(i).forEach(({req:e,retryCount:t=0})=>{if(e.id){if(t>=3)throw new Error(`StreamMiddleware - Retry limit exceeded for request id "${e.id}"`);i[e.id].retryCount=t+1,d(e)}})}}exports.createStreamMiddleware=b;
